---
- name: Copy local directory contents to remote host
  hosts: all
  become: true
  become_method: su
  tasks:
    - name: Shutdown container if active
      ansible.builtin.command: /usr/sbin/pct shutdown {{ vmid }}
      args:
        removes: /var/lib/lxc/{{ vmid }}/rootfs/etc
      ignore_errors: true

    - name: Mount CT rootfs if not already mounted
      ansible.builtin.command: /usr/sbin/pct mount {{ vmid }}
      args:
        creates: "{{ remote_root_path }}/etc"

    - name: Verify local directory exists (runs on control node)
      stat:
        path: "{{ local_directory }}"
      delegate_to: localhost
      become: false
      register: local_dir_stat
      failed_when: not (local_dir_stat.stat.exists and local_dir_stat.stat.isdir)

    - name: Ensure remote directory exists
      file:
        path: "{{ remote_root_path }}/etc/traefik"
        state: directory
        mode: "0755"

    - name: Ensure remote directory exists
      file:
        path: "{{ remote_root_path }}/etc/traefik/conf"
        state: directory
        mode: "0755"

    - name: Copy Traefik configuration from template
      ansible.builtin.template:
        src: "{{ local_directory }}/traefik.j2"
        dest: "{{ remote_root_path }}/etc/traefik/traefik.yaml"
        owner: 100000
        group: 100000
        mode: "0755"
      # vars:
        # dashboard_enabled: "{{ dashboard_enabled }}"
        # insecure_dashboard: "{{ insecure_dashboard }}"
        # log_level: "{{ log_level }}"
        # k8s_gateway_yaml: "{{ k8s_gateway_yaml }}"

    - name: Copy middlewares from template
      ansible.builtin.template:
        src: "{{ local_directory }}/conf/middlewares.j2"
        dest: "{{ remote_root_path }}/etc/traefik/conf/middlewares.yaml"
        owner: 100000
        group: 100000
        mode: "0755"
      vars:
        middlewares_yaml: "{{ middlewares_yaml }}"

    - name: Copy routers from template
      ansible.builtin.template:
        src: "{{ local_directory }}/conf/routers.j2"
        dest: "{{ remote_root_path }}/etc/traefik/conf/routers.yaml"
        owner: 100000
        group: 100000
        mode: "0755"
      vars:
        routers_yaml: "{{ routers_yaml }}"

    - name: Copy services from template
      ansible.builtin.template:
        src: "{{ local_directory }}/conf/services.j2"
        dest: "{{ remote_root_path }}/etc/traefik/conf/services.yaml"
        owner: 100000
        group: 100000
        mode: "0755"
      vars:
        services_yaml: "{{ services_yaml }}"

    - name: Copy k8s certificate
      ansible.builtin.copy:
        content: "{{ k8s_certificate }}"
        dest: "{{ remote_root_path }}//etc/traefik/k8s-ca.crt"
        owner: 100000
        group: 100000
        mode: "0644"

    - name: Unmount CT rootfs
      ansible.builtin.command: /usr/sbin/pct unmount {{ vmid }}
      args:
        removes: /var/lib/lxc/{{ vmid }}/rootfs/etc

    - name: Start container
      ansible.builtin.command: /usr/sbin/pct start {{ vmid }}
